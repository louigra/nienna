<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nienna — Programming</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 mb-0">Programming</h1>
      <div class="d-flex gap-2">
        <button id="add-btn" class="btn btn-primary">Add Project</button>
        <a class="btn btn-outline-light" href="landingpage.html">Back to Dashboard</a>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="h4 mb-0">Tier</h2>
        <form>
            <label for="tier-select">Tier</label>
            <select id="tier-select" name="selected-tier">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
        </form>
      </div>

      <div>
        <h2 class="h4 mb-0">Filter</h2>
        <form>
          <label for="category-select">Category</label>
          <select id="category-select" name="selected-category">
            <option value="8">08</option>
            <option value="9">09</option>
          </select>
          <label for="element-select">Element</label>
          <select id="element-select" name="selected-element">
            <option value="2">02</option>
            <option value="3">03</option>
            <option value="4">04</option>
            <option value="6">06</option>
          </select>
          <label for="cip-select">CIP</label>
          <select id="cip-select" name="selected-cip">
            <option value="9">9</option>
          </select>
        </form>
      </div>
    </div>

    <div id="table-wrap" class="table-responsive"></div>
    <p class="text-secondary small" id="app-msg"></p>
  </div>

  <!-- Add/Edit Project Modal -->
  <div class="modal fade" id="projectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title" id="projectModalTitle">Add Project</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="projectForm">
          <div class="modal-body">
            <input type="hidden" id="proj-id" />
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label" for="proj-title">Project Title</label>
                <input id="proj-title" class="form-control" placeholder="e.g., Fiber Optic Cable" required />
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="proj-category">Category</label>
                <input id="proj-category" class="form-control" placeholder="e.g., 8" />
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="proj-element">Element</label>
                <input id="proj-element" class="form-control" placeholder="e.g., 01" />
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="proj-cip">CIP</label>
                <input id="proj-cip" class="form-control" placeholder="e.g., 9" />
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="y1">Year 1</label>
                <input id="y1" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="y2">Year 2</label>
                <input id="y2" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="y3">Year 3</label>
                <input id="y3" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="y4">Year 4</label>
                <input id="y4" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="y5">Year 5</label>
                <input id="y5" type="number" step="0.01" class="form-control" />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="delete-btn" type="button" class="btn btn-outline-danger me-auto d-none">Delete</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button id="save-btn" type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS bundle (for Modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script type="module">
    import { supabase, requireAuth } from "./auth-guard.js";
    await requireAuth(); // redirect to login if not authed

    const wrap   = document.getElementById('table-wrap');
    const appMsg = document.getElementById('app-msg');
    const addBtn = document.getElementById('add-btn');

    const modalEl = document.getElementById('projectModal');
    const modal   = new bootstrap.Modal(modalEl);
    const form    = document.getElementById('projectForm');

    const idInput   = document.getElementById('proj-id');
    const titleEl   = document.getElementById('proj-title');
    const catEl     = document.getElementById('proj-category');
    const elemEl    = document.getElementById('proj-element');
    const cipEl     = document.getElementById('proj-cip');
    const y1El      = document.getElementById('y1');
    const y2El      = document.getElementById('y2');
    const y3El      = document.getElementById('y3');
    const y4El      = document.getElementById('y4');
    const y5El      = document.getElementById('y5');
    const deleteBtn = document.getElementById('delete-btn');
    const modalTitle= document.getElementById('projectModalTitle');

    let currentRows = [];



    async function loadProjects() {
        appMsg.textContent = 'Loading…';
      
        const filters = getFilters();
      
        let query = supabase
          .from('programming_projects')
          .select(`
            id,
            project_title,
            year1value, year2value, year3value, year4value, year5value,
            cip, category, element,
            tier1multiplier, tier2multiplier, tier3multiplier
          `)
          .order('id', { ascending: true });
      
        // Apply filters: cip/category = numbers, element = text
        if (filters.category) query = query.eq('category', Number(filters.category));
        if (filters.cip)      query = query.eq('cip', Number(filters.cip));
        if (filters.element)  query = query.eq('element', Number(filters.element));
      
        const { data, error } = await query;
      
        if (error) { 
          appMsg.textContent = error.message; 
          return; 
        }
      
        currentRows = data || [];
        appMsg.textContent = `Loaded ${currentRows.length} row(s)`;
        renderTable(currentRows, getSelectedTier());
      }

    const tierSelect = document.getElementById('tier-select');
    const categorySelect = document.getElementById('category-select');
    const elementSelect = document.getElementById('element-select');
    const cipSelect = document.getElementById('cip-select');

    tierSelect.addEventListener('change', () => {
        renderTable(currentRows, getSelectedTier());
    });

    categorySelect.addEventListener('change', async () => {
        await loadProjects();
    });
    elementSelect.addEventListener('change', async () => {
        await loadProjects();
    });
    cipSelect.addEventListener('change', async () => {
        await loadProjects();
    });

    function getSelectedTier() {
        return Number(tierSelect?.value || 1);
    }

    function getFilters() {
        const filters = {};
        const cat = categorySelect?.value;
        const elem = elementSelect?.value;
        const cip = cipSelect?.value;
        if (cat) filters.category = cat;
        if (elem) filters.element = elem;
        if (cip) filters.cip = cip;
        return filters;
    }

    function getMultiplier(row, tier) {
        if (tier === 1) return Number(row.tier1multiplier ?? 1);
        if (tier === 2) return Number(row.tier2multiplier ?? 1);
        if (tier === 3) return Number(row.tier3multiplier ?? 1);
        return 1;
    }

    function scaled(value, mult) {
        const base = Number(value);
        if (!isFinite(base)) return '';  // keep empty if not a number
        const out = base * mult;
        // format as needed: integer if whole, otherwise with up to 2 decimals
        return Number.isInteger(out) ? String(out) : out.toFixed(2);
    }

    // Render table
    function renderTable(rows, tier = 1) {
        wrap.innerHTML = '';
        if (!rows.length) {
        wrap.innerHTML = '<div class="text-secondary">No rows.</div>';
        return;
        }
    
        // headers to display
        const headers = ['id','project_title','year1value','year2value','year3value','year4value','year5value'];
    
        const table = document.createElement('table');
        table.className = 'table table-sm table-striped table-hover align-middle';
    
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        trh.appendChild(th);
        });
        thead.appendChild(trh);
        table.appendChild(thead);
    
        const tbody = document.createElement('tbody');
    
        rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.dataset.id = r.id;
    
        const mult = getMultiplier(r, tier);
    
        headers.forEach(h => {
            const td = document.createElement('td');
            if (h.startsWith('year') && h.endsWith('value')) {
            td.textContent = scaled(r[h], mult);
            } else {
            td.textContent = r[h] ?? '';
            }
            tr.appendChild(td);
        });
    
        tbody.appendChild(tr);
        });
    
        table.appendChild(tbody);
        wrap.appendChild(table);
    
        // Event delegation: click any row to edit (passes the RAW row, not scaled)
        tbody.onclick = (e) => {
        const tr = e.target.closest('tr');
        if (!tr) return;
        const id = Number(tr.dataset.id);
        const row = currentRows.find(x => x.id === id);
        if (row) openEditModal(row);
        };
    }

    // Open modal for adding new
    addBtn.onclick = () => openAddModal();

    function clearForm() {
      idInput.value = '';
      titleEl.value = '';
      catEl.value   = '';
      elemEl.value  = '';
      cipEl.value   = '';
      y1El.value = y2El.value = y3El.value = y4El.value = y5El.value = '';
    }

    function fillForm(row) {
      idInput.value = row.id ?? '';
      titleEl.value = row.project_title ?? '';
      catEl.value   = row.category ?? '';
      elemEl.value  = row.element ?? '';
      cipEl.value   = row.cip ?? '';
      y1El.value    = row.year1value ?? '';
      y2El.value    = row.year2value ?? '';
      y3El.value    = row.year3value ?? '';
      y4El.value    = row.year4value ?? '';
      y5El.value    = row.year5value ?? '';
    }

    function openAddModal() {
      clearForm();
      modalTitle.textContent = 'Add Project';
      deleteBtn.classList.add('d-none');
      modal.show();
    }

    // if a row is passed in, then open for editing
    function openEditModal(row) {
      fillForm(row);
      // set the title on the modal
      modalTitle.textContent = `Edit ${row.project_title || 'Project'}`;
      deleteBtn.classList.remove('d-none');
      modal.show();
    }

    // Save (insert or update)
    form.onsubmit = async (e) => {
      e.preventDefault();
      const payload = {
        project_title: titleEl.value.trim(),
        category:      catEl.value.trim() || null,
        year1value:    valOrNull(y1El.value),
        year2value:    valOrNull(y2El.value),
        year3value:    valOrNull(y3El.value),
        year4value:    valOrNull(y4El.value),
        year5value:    valOrNull(y5El.value),
        cip:           valOrNull(cipEl.value), 
        element:       valOrNull(elemEl.value),
      };

      const id = idInput.value ? Number(idInput.value) : null;
      let error;

      if (!payload.project_title) {
        // basic validation
        titleEl.focus();
        return;
      }

      if (id) {
        ({ error } = await supabase.from('programming_projects').update(payload).eq('id', id));
      } else {
        ({ error } = await supabase.from('programming_projects').insert([payload]));
      }

      if (error) {
        appMsg.textContent = error.message;
        return;
      }

      modal.hide();
      await loadProjects(getFilters());
    };

    // Delete
    deleteBtn.onclick = async () => {
      const id = idInput.value ? Number(idInput.value) : null;
      if (!id) return;
      if (!confirm('Delete this project?')) return;

      const { error } = await supabase.from('programming_projects').delete().eq('id', id);
      if (error) { appMsg.textContent = error.message; return; }

      modal.hide();
      await loadProjects(getFilters);
    };

    function valOrNull(v) {
      if (v === '' || v === null || v === undefined) return null;
      const n = Number(v);
      return Number.isNaN(n) ? null : n;
    }

    // Initial load
    loadProjects(getFilters());
  </script>
</body>
</html>
