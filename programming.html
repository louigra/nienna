<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nienna — Programming</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="./styles.css" rel="stylesheet" />
  <style>
    :root {
      --brand: #0039A6;
      --glass-bg: rgba(18, 20, 25, 0.6);
      --glass-border: rgba(255,255,255,.08);
    }
    body { 
      background: radial-gradient(1200px 600px at 10% -10%, rgba(0, 57, 166, .22), transparent),
                  radial-gradient(1200px 600px at 90% 110%, rgba(0, 0, 0, .18), transparent),
                  linear-gradient(160deg, #0b0c10 0%, #0f1116 100%);
      min-height: 100vh;
    }
    .page-header {
      background: linear-gradient(90deg, rgba(0, 57, 166, .2), rgba(233, 87, 77, 0));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .toolbar-card, .filters-card, .table-wrap-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .btn-brand { background: var(--brand); border-color: var(--brand); }
    .btn-brand:hover { filter: brightness(1.08); }
    .select-inline { min-width: 120px; }
    .section-title { letter-spacing: .02em; }
    .table-wrap-card{ border-radius: 1rem; }
    .muted { color: #98a2b3; }

    .budget-panel {
      background: rgba(15,15,18,.35);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    
    .progress {
      background: rgba(255,255,255,.06) !important;
    }
    .progress-bar.bg-success {
      background-color: #28a745 !important;
    }
    .progress-bar.bg-danger {
      background-color: #dc3545 !important;
    }
  </style>
</head>
<body>

  <div class="page-header">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          <i class="bi bi-terminal fs-3 text-warning"></i>
          <div>
            <h1 class="h4 mb-0">Programming</h1>
            <div class="muted small">Build a capital program</div>
          </div>
        </div>
        <div class="d-flex gap-2">
          <button id="add-btn" class="btn btn-brand"><i class="bi bi-plus-circle me-1"></i> Add Project</button>
          <a class="btn btn-outline-light" href="landingpage.html"><i class="bi bi-grid-3x3-gap text-warning me-1"></i> Back to Tiles</a>
        </div>
      </div>
    </div>
  </div>

  <div class="container py-4">
    <!-- Controls Row -->
    <div class="row g-3 align-items-stretch mb-3">
      <!-- Tier card -->
      <div class="col-12 col-lg-4">
        <div class="toolbar-card h-100 p-3">
          <h2 class="h6 mb-3 section-title">Tier</h2>
          <form class="row g-2 align-items-center">
            <div class="col-auto"><label for="tier-select" class="col-form-label">Tier</label></div>
            <div class="col-auto">
              <select id="tier-select" name="selected-tier" class="form-select select-inline">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
            </div>
          </form>
        </div>
      </div>

      <!-- Filters card -->
      <div class="col-12 col-lg-8">
        <div class="filters-card h-100 p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="h6 mb-0 section-title">Filter</h2>
            <div class="muted small">Use any combination</div>
          </div>
          <form class="row g-2">
            <div class="col-12 col-sm-3">
              <label for="agency-select" class="form-label">Agency</label>
              <select id="agency-select" name="selected-agency" class="form-select">
              </select>
            </div>
            <div class="col-12 col-sm-3">
              <label for="cip-select" class="form-label">CIP</label>
              <select id="cip-select" name="selected-cip" class="form-select">
              </select>
            </div>
            <div class="col-12 col-sm-3">
              <label for="category-select" class="form-label">Category</label>
              <select id="category-select" name="selected-category" class="form-select">
              </select>
            </div>
            <div class="col-12 col-sm-3">
              <label for="element-select" class="form-label">Element</label>
              <select id="element-select" name="selected-element" class="form-select">
              </select>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Table area -->
    <div class="table-wrap-card h-100 p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 mb-0 section-title">Projects</h2>
        <div class="muted small">Click any row to edit that project</div>
      </div>
      <div id="table-wrap" class="table-responsive"></div>
    </div>

    <p class="text-secondary small mt-2" id="app-msg"></p>
  </div>

  <!-- Add/Edit Project Modal (IDs preserved) -->
  <div class="modal fade" id="projectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title" id="projectModalTitle">Add Project</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="projectForm">
          <div class="modal-body">
            <input type="hidden" id="proj-id" />
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label" for="proj-title">Project Title</label>
                <input id="proj-title" class="form-control" placeholder="e.g., Fiber Optic Cable" required />
              </div>
            </div>
            <div class="row g-3">
              <div class="col-6 col-md-2">
                <label class="form-label" for="proj-agency">Agency</label>
                <input id="proj-agency" class="form-control" placeholder="e.g. T">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="proj-category">Category</label>
                <input id="proj-category" class="form-control" placeholder="e.g., 8" />
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="proj-element">Element</label>
                <input id="proj-element" class="form-control" placeholder="e.g., 01" />
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="proj-cip">CIP</label>
                <input id="proj-cip" class="form-control" placeholder="e.g., 9" />
              </div>
            </div>
            <div class="row g-3">
              <div class="col-6 col-md-2">
                <label class="form-label" for="y1">Year 1</label>
                <input id="y1" type="number" step="1" class="form-control" />
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="y2">Year 2</label>
                <input id="y2" type="number" step="1" class="form-control" />
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="y3">Year 3</label>
                <input id="y3" type="number" step="1" class="form-control" />
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="y4">Year 4</label>
                <input id="y4" type="number" step="1" class="form-control" />
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="y5">Year 5</label>
                <input id="y5" type="number" step="1" class="form-control" />
              </div>
            </div>
            <div class="row g-3">
              <div class="col-6 col-md-2">
                <label class="form-label" for="t1multiplier">Tier 1 Multiplier</label>
                <input id="t1multiplier" type="number" step="0.01" class="form-control"/>
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="t2multiplier">Tier 2 Multiplier</label>
                <input id="t2multiplier" type="number" step="0.01" class="form-control"/>
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="t3multiplier">Tier 3 Multiplier</label>
                <input id="t3multiplier" type="number" step="0.01" class="form-control"/>
              </div>
            </div>
            <div class="row g-3">
              <div class="col-6 col-md-2">
                <label class="form-label" for="estimateYear">Estimate Year</label>
                <input id="estimateYear" type="number" step="1" class="form-control"/>
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label" for="awardYear">Award Year</label>
                <input id="awardYear" type="number" step="1" class="form-control"/>
              </div>
            </div>
          </div><!-- /modal-body -->

          <div class="modal-footer">
            <button id="delete-btn" type="button" class="btn btn-outline-danger me-auto d-none"><i class="bi bi-trash"></i> Delete</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button id="save-btn" type="submit" class="btn btn-brand"><i class="bi bi-save2 me-1"></i> Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>


  <!-- Bootstrap JS bundle (for Modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script type="module">
    import { supabase, requireAuth } from "./auth-guard.js";
    import { getInflatorsOnce, getInflatorMap, inflate } from "./inflation.js";

    const wrap   = document.getElementById('table-wrap');
    const appMsg = document.getElementById('app-msg');
    const addBtn = document.getElementById('add-btn');

    const modalEl = document.getElementById('projectModal');
    const modal   = new bootstrap.Modal(modalEl);
    const form    = document.getElementById('projectForm');

    const idInput   = document.getElementById('proj-id');
    const titleEl   = document.getElementById('proj-title');
    const agencyEl  = document.getElementById('proj-agency');
    const catEl     = document.getElementById('proj-category');
    const elemEl    = document.getElementById('proj-element');
    const cipEl     = document.getElementById('proj-cip');
    const y1El      = document.getElementById('y1');
    const y2El      = document.getElementById('y2');
    const y3El      = document.getElementById('y3');
    const y4El      = document.getElementById('y4');
    const y5El      = document.getElementById('y5');
    const t1multEl  = document.getElementById('t1multiplier');
    const t2multEl  = document.getElementById('t2multiplier');
    const t3multEl  = document.getElementById('t3multiplier');
    const estYearEl = document.getElementById('estimateYear');
    const awardYearEl = document.getElementById('awardYear');
    const deleteBtn = document.getElementById('delete-btn');
    const modalTitle= document.getElementById('projectModalTitle');

    let currentRows = [];
    let currentEnvelope = null;

    function getSelectedTier() {
      return Number(tierSelect?.value || 1);
    }

    function getFilters() {
      const filters = {};
      const agency = agencySelect?.value;
      const cat = categorySelect?.value;
      const elem = elementSelect?.value;
      const cip = cipSelect?.value;
      if (cat) filters.category = cat;
      if (elem) filters.element = elem;
      if (cip) filters.cip = cip;
      if (agency) filters.agency = agency;
      return filters;
    }

    function getMultiplier(row, tier) {
      if (tier === 1) return Number(row.tier1multiplier ?? 1);
      if (tier === 2) return Number(row.tier2multiplier ?? 1);
      if (tier === 3) return Number(row.tier3multiplier ?? 1);
      return 1;
    }

    function scaled(value, mult) {
      const base = Number(value);
      if (!isFinite(base)) return '';  // keep empty if not a number
      const out = base * mult;
      return Number.isInteger(out) ? String(out) : out.toFixed(2);
    }

    // Coerce to Number safely; return null if not a finite number
    const asNum = (v) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    };

    // Fetch envelope for the current (tier, category, element, cip)
    async function fetchEnvelopeForFilters({ tier, category, element, cip, agency }) {
      const tierVal = asNum(tier);
      const catVal  = asNum(category);
      const elemVal = asNum(element);
      const cipVal  = asNum(cip);
      const agencyVal = agency;

      if (tierVal == null || catVal == null || elemVal == null || cipVal == null || agencyVal == null) {
        return null;
      }

      const { data, error } = await supabase
        .from('tier_acep_envelope')
        .select('acep_envelope')
        .eq('agency', agencyVal)          
        .eq('tier', tierVal)
        .eq('category', catVal)
        .eq('element', elemVal)
        .eq('cip', cipVal)        
        .maybeSingle();                   // returns data=null when no row, no throw

      if (error) throw error;
      return data?.acep_envelope ?? null;
    }

    async function refreshEnvelopeAndRender() {
      const filters = getFilters();
      const tier = getSelectedTier();
    
      currentEnvelope = null; // reset until we know
    
      if (filters.category && filters.element && filters.cip && filters.agency) {
        try {
          const envelope = await fetchEnvelopeForFilters({
            tier,
            agency: filters.agency,
            category: filters.category,
            element:  filters.element,
            cip:      filters.cip,
          });
          currentEnvelope = envelope; // may be null if none
        } catch (err) {
          console.error('Envelope fetch error:', err);
          appMsg.textContent = `Error loading envelope: ${err.message}`;
        }
      }
    
      // re-render with the envelope we just fetched
      renderTable(currentRows, getSelectedTier(), currentEnvelope);
    }

    async function loadProjects() {
      appMsg.textContent = 'Loading…';
      const filters = getFilters();


      let query = supabase
        .from('programming_projects')
        .select(`
          id,
          project_title,
          year1value, year2value, year3value, year4value, year5value,
          agency, cip, category, element,
          tier1multiplier, tier2multiplier, tier3multiplier,
          estimate_year, award_year
        `)
        .order('id', { ascending: true });

      // Apply filters: cip/category = numbers, element = text
      if (filters.agency)   query = query.eq('agency', filters.agency)
      if (filters.category) query = query.eq('category', Number(filters.category));
      if (filters.cip)      query = query.eq('cip', Number(filters.cip));
      if (filters.element)  query = query.eq('element', filters.element);

      const { data, error } = await query;

      if (error) { 
        appMsg.textContent = error.message; 
        return; 
      }

      currentRows = data || [];
      appMsg.textContent = `Loaded ${currentRows.length} row(s)`;
      refreshEnvelopeAndRender();
    }

    const tierSelect = document.getElementById('tier-select');
    const agencySelect = document.getElementById('agency-select');
    const categorySelect = document.getElementById('category-select');
    const elementSelect = document.getElementById('element-select');
    const cipSelect = document.getElementById('cip-select');

    tierSelect.addEventListener('change', () => {
      refreshEnvelopeAndRender();
    });
    agencySelect.addEventListener('change', async () => {
      await loadProjects();
    });
    categorySelect.addEventListener('change', async () => {
      await loadProjects();
    });
    elementSelect.addEventListener('change', async () => {
      await loadProjects();
    });
    cipSelect.addEventListener('change', async () => {
      await loadProjects();
    });

    // key allows the data to match and label is what shows up on the screen
      const COLUMNS = [
      { key: 'id',             label: 'ID' },
      { key: 'project_title',  label: 'Project' },
      { key: 'year1value',     label: 'Y1',  isYear: true },
      { key: 'year2value',     label: 'Y2',  isYear: true },
      { key: 'year3value',     label: 'Y3',  isYear: true },
      { key: 'year4value',     label: 'Y4',  isYear: true },
      { key: 'year5value',     label: 'Y5',  isYear: true },
      ];

      function renderTable(rows, tier = 1, envelope = null) {
        const wrapEl = wrap;
        wrapEl.innerHTML = '';
        if (!rows.length) {
          wrapEl.innerHTML = '<div class="text-secondary">No rows.</div>';
          return;
        }
      
        const table = document.createElement('table');
        table.className = 'table table-sm table-striped table-hover align-middle';
      
        // THEAD
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        COLUMNS.forEach(col => {
          const th = document.createElement('th');
          th.textContent = col.label;           // show the friendly label
          trh.appendChild(th);
        });
        thead.appendChild(trh);
        table.appendChild(thead);
      
        // TBODY
        const tbody = document.createElement('tbody');
        let elementTotal = 0;
      
        rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.dataset.id = r.id;
      
          const mult = getMultiplier(r, tier);
      
          COLUMNS.forEach(col => {
            const td = document.createElement('td');
      
            if (col.isYear) {
              const scaledStr   = scaled(r[col.key], mult);
              const inflatedStr = inflate(scaledStr, r.estimate_year, r.award_year);
              td.textContent = inflatedStr;
      
              const n = Number(inflatedStr);
              if (Number.isFinite(n)) elementTotal += n;
            } else {
              td.textContent = r[col.key] ?? '';
            }
      
            tr.appendChild(td);
          });
      
          tbody.appendChild(tr);
        });
      
        table.appendChild(tbody);
      
        // TFOOT (Total)
        const firstYearIdx = COLUMNS.findIndex(c => c.isYear);
        const labelSpan = firstYearIdx > 0 ? firstYearIdx : Math.min(2, COLUMNS.length); // fallback
      
        const tfoot = document.createElement('tfoot');
        const trf = document.createElement('tr');
      
        const thLabel = document.createElement('th');
        thLabel.colSpan = labelSpan;
        thLabel.className = 'text-end';
        thLabel.textContent = 'Total:';
        trf.appendChild(thLabel);
      
        const thTotal = document.createElement('th');
        thTotal.colSpan = COLUMNS.length - labelSpan;
        thTotal.textContent = Number(elementTotal).toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
        trf.appendChild(thTotal);
      
        tfoot.appendChild(trf);
        table.appendChild(tfoot);
      
        wrapEl.appendChild(table);

      // --- Comparison panel (below the table) ---
const panel = document.createElement('div');
panel.className = 'budget-panel mt-3 p-3 rounded-3';

if (envelope != null && Number.isFinite(Number(envelope))) {
  const total = Number(elementTotal);
  const env   = Number(envelope);
  const delta = env - total;  // positive = under; negative = over
  const within = delta >= 0;

  const fmt = (n) => Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // progress ratio capped between 0–100%
  const ratio = env > 0 ? Math.max(0, Math.min(1, total / env)) : 0;

  panel.innerHTML = `
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
      <div>
        <div class="small text-secondary">Tier ${getSelectedTier()} Envelope</div>
        <div class="fs-5 fw-semibold">$${fmt(env)}</div>
      </div>

      <div class="text-end">
        <div class="small text-secondary">Current Total</div>
        <div class="fs-5 fw-semibold">$${fmt(total)}</div>
      </div>

      <div class="text-end">
        <div class="small text-secondary">Delta ${within ? '(Remaining)' : '(Over)'}</div>
        <div class="fs-5 fw-semibold ${within ? 'text-success' : 'text-danger'}">
          ${within ? '' : '-'}$${fmt(Math.abs(delta))}
        </div>
      </div>
    </div>

    <div class="mt-3">
      <div class="progress bg-transparent border border-1 rounded-pill" style="height: 12px;">
        <div class="progress-bar ${within ? 'bg-success' : 'bg-danger'}" role="progressbar"
             style="width: ${ratio * 100}%" aria-valuenow="${(ratio*100).toFixed(0)}"
             aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <div class="d-flex justify-content-between small mt-1">
        <span class="text-secondary">0</span>
        <span class="text-secondary">$${fmt(env)}</span>
      </div>
    </div>`;

} else {
  panel.innerHTML = `
    <div class="d-flex align-items-center justify-content-between">
      <div class="small text-secondary">No envelope found for the current filters.</div>
    </div>`;
}

wrapEl.appendChild(panel);

      // Event delegation: click any row to edit (passes RAW row)
      tbody.onclick = (e) => {
        const tr = e.target.closest('tr');
        if (!tr) return;
        const id = Number(tr.dataset.id);
        const row = currentRows.find(x => x.id === id);
        if (row) openEditModal(row);
      };
    }

    // Open modal for adding new
    addBtn.onclick = () => openAddModal();

    function clearForm() {
      idInput.value = '';
      titleEl.value = '';
      agencyEl.value = '';
      catEl.value   = '';
      elemEl.value  = '';
      cipEl.value   = '';
      y1El.value = y2El.value = y3El.value = y4El.value = y5El.value = '';
      t1multEl.value = t2multEl.value = t3multEl.value = '';
      estYearEl.value = '';
      awardYearEl.value = '';
    }

    function fillForm(row) {
      idInput.value = row.id ?? '';
      titleEl.value = row.project_title ?? '';
      agencyEl.value = row.agency ?? '';
      catEl.value   = row.category ?? '';
      elemEl.value  = row.element ?? '';
      cipEl.value   = row.cip ?? '';
      y1El.value    = row.year1value ?? '';
      y2El.value    = row.year2value ?? '';
      y3El.value    = row.year3value ?? '';
      y4El.value    = row.year4value ?? '';
      y5El.value    = row.year5value ?? '';
      t1multEl.value= row.tier1multiplier ?? '';
      t2multEl.value= row.tier2multiplier ?? '';
      t3multEl.value= row.tier3multiplier ?? '';
      estYearEl.value = row.estimate_year ?? '';
      awardYearEl.value = row.award_year ?? '';
    }

    function openAddModal() {
      clearForm();
      modalTitle.textContent = 'Add Project';
      deleteBtn.classList.add('d-none');
      modal.show();
    }

    function openEditModal(row) {
      fillForm(row);
      modalTitle.textContent = `Edit ${row.project_title || 'Project'}`;
      deleteBtn.classList.remove('d-none');
      modal.show();
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      const payload = {
        project_title: titleEl.value.trim(),
        category:      catEl.value.trim() || null,
        agency :       agencyEl.value.trim() || null,
        year1value:    valOrNull(y1El.value),
        year2value:    valOrNull(y2El.value),
        year3value:    valOrNull(y3El.value),
        year4value:    valOrNull(y4El.value),
        year5value:    valOrNull(y5El.value),
        cip:           valOrNull(cipEl.value), 
        element:       (elemEl.value.trim() || null),
        tier1multiplier: valOrNull(t1multEl.value),
        tier2multiplier: valOrNull(t2multEl.value),
        tier3multiplier: valOrNull(t3multEl.value),
        estimate_year:   valOrNull(estYearEl.value),
        award_year:      valOrNull(awardYearEl.value),
      };

      const id = idInput.value ? Number(idInput.value) : null;
      let error;

      if (!payload.project_title) {
        titleEl.focus();
        return;
      }

      if (id) {
        ({ error } = await supabase.from('programming_projects').update(payload).eq('id', id));
      } else {
        ({ error } = await supabase.from('programming_projects').insert([payload]));
      }

      if (error) {
        appMsg.textContent = error.message;
        return;
      }

      modal.hide();
      await loadProjects();
    };

    deleteBtn.onclick = async () => {
      const id = idInput.value ? Number(idInput.value) : null;
      if (!id) return;
      if (!confirm('Delete this project?')) return;

      const { error } = await supabase.from('programming_projects').delete().eq('id', id);
      if (error) { appMsg.textContent = error.message; return; }

      modal.hide();
      await loadProjects();
    };

    function valOrNull(v) {
      if (v === '' || v === null || v === undefined) return null;
      const n = Number(v);
      return Number.isNaN(n) ? null : n;
    }

    // --- Distinct helper & filter builder (ACEPs) ---

    async function getDistinct(table, column) {
        const { data, error } = await supabase
        .from(table)
        .select(column, { distinct: true })
        .not(column, 'is', null)
        .order(column, { ascending: true });
    
        if (error) throw error;
        return (data || []).map(r => r[column]).filter(v => v !== null && v !== undefined);
        console.log(data)
    }
    
    function fillSelect(selectEl, values, { display = v => String(v), value = v => String(v) } = {}) {
        selectEl.innerHTML = '<option value="">All</option>';
        const uniq = [...new Set(values)];
        for (const v of uniq) {
        const opt = document.createElement('option');
        opt.value = value(v);
        opt.textContent = display(v);
        selectEl.appendChild(opt);
        }
    }
    async function buildFiltersFromACEPs() {
        appMsg.textContent = 'Loading filters…';
    
        const [agencies, cips, cats, elems] = await Promise.all([
        getDistinct('aceps', 'agency'),
        getDistinct('aceps', 'cip'),
        getDistinct('aceps', 'category'),
        getDistinct('aceps', 'element')
        ]);
      
        fillSelect(agencySelect, agencies, {
          value: v => String(v),
          display: v => String(v)
        });

        fillSelect(cipSelect, cips, {
        value: v => String(v),
        display: v => String(v)
        });
    
        fillSelect(categorySelect, cats, {
        value: v => String(v),
        display: v => String(v).padStart(2,'0')
        });
    
        fillSelect(elementSelect, elems, {
        value: v => String(v),
        display: v => String(v).padStart(2,'0')
        });
    
        appMsg.textContent = ''; 
    }

    // ---- Boot ----
    try {
      await requireAuth();
      await getInflatorsOnce();
      await buildFiltersFromACEPs();
      await loadProjects();
    } catch (err) {
      console.error('Initialization error:', err);
      if (appMsg) appMsg.textContent = 'Error during initialization. See console.';
    }
  </script>
</body>
</html>
