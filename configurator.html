<!-- configurator.html -->
<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nienna — Configurator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="./style.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <style>
    .layout { 
      display: grid; 
      grid-template-columns: 300px minmax(0,1fr); /* ensure right pane can grow */
      min-height: 100vh; 
      width: 100%;                /* <-- important */
    }
    .sidebar { width: 300px; }    /* explicit so it doesn’t collapse */
    
    .sidebar {
      border-right: 1px solid rgba(255,255,255,.08);
      background: rgba(15,15,18,.5); backdrop-filter: blur(8px);
    }
    .sidebar .active { background: rgba(255,255,255,.08); }
    .toolbar { border-bottom: 1px solid rgba(255,255,255,.08); }
    .table-wrap { overflow:auto; }

    .page-header {
      background: linear-gradient(90deg, rgba(0, 57, 166, .2), rgba(233, 87, 77, 0));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
  </style>
</head>
<body class="app">

  <div class="page-header">
    <div class="container-fluid py-4">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          <i class="bi bi-window-stack fs-3 text-warning"></i>
          <div>
            <h1 class="h4 mb-0">Configuration</h1>
            <div class="muted small">Configure the tables that support the apps</div>
          </div>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-light" href="landingpage.html"><i class="bi bi-speedometer2 me-1"></i> Back to Dashboard</a>
        </div>
      </div>
    </div>
  </div>

  <div class="layout">
    <!-- Left toolbar -->
    <aside class="sidebar p-3">
      <h2 class="h6 text-secondary mb-3">Tables</h2>
      <nav id="table-list" class="list-group list-group-flush small"></nav>
      <hr class="text-secondary my-3" />
      <div id="sidebar-extra" class="small text-secondary"></div>
    </aside>

    <!-- Right pane -->
    <main class="d-flex flex-column">
      <div class="toolbar p-3 d-flex gap-2 align-items-center">
        <h1 id="page-title" class="h5 mb-0 flex-grow-1">Configurator</h1>
        <input id="search-input" class="form-control form-control-sm" placeholder="Search…" style="max-width:220px"/>
        <button id="add-btn" class="btn btn-primary btn-sm">Add</button>
      </div>

      <div id="filters" class="p-3 d-flex flex-wrap gap-2"></div>
      <div class="p-3 table-wrap">
        <div id="table-region" class="table-responsive"></div>
        <div id="pager" class="d-flex justify-content-between align-items-center mt-3 small"></div>
        <p id="status" class="text-secondary small mt-2"></p>
      </div>
    </main>
  </div>

  <!-- Modal host -->
  <div id="modal-host"></div>

  <script>
    // Surface ANY script errors to the page + console
    window.addEventListener('error', (e) => {
      console.error('[window.error]', e.message, e.filename, e.lineno);
      const s = document.getElementById('status');
      if (s) s.textContent = `Error: ${e.message}`;
    });
    window.addEventListener('unhandledrejection', (e) => {
      console.error('[unhandledrejection]', e.reason);
      const s = document.getElementById('status');
      if (s) s.textContent = `Unhandled: ${e.reason?.message || e.reason}`;
    });
  </script>

  <script type="module">
    const statusEl = document.getElementById('status');
    const sidebarEl = document.getElementById('table-list');
  
    console.log('[BOOT] inline module probe OK');
  
    // Helper to import a module and log a super-clear error if it fails
    async function safeImport(path) {
      try {
        const mod = await import(path);
        console.log('[IMPORT OK]', path, Object.keys(mod));
        return mod;
      } catch (err) {
        console.error('[IMPORT FAIL]', path, err);
        if (statusEl) statusEl.textContent = `Failed to import ${path}: ${err?.message || err}`;
        throw err;
      }
    }
  
    // IMPORTANT: these paths must match your on-disk layout exactly.
    // You said: configurator.html and auth-guard.js at same level,
    // and ./configurator/modules/... for the rest — so these should be correct:
    const { requireAuth } = await safeImport('./auth-guard.js');
    const { initRouter } = await safeImport('./configurator/modules/router.js');
    const { buildSidebar } = await safeImport('./configurator/modules/ui/sidebar.js');
    const { renderTableView } = await safeImport('./configurator/modules/ui/tableView.js');
    const { TABLES } = await safeImport('./configurator/modules/tables.config.js');
  
    console.log('[BOOT] modules imported', { tableKeys: Object.keys(TABLES || {}) });
  
    // Auth
    try {
      const session = await requireAuth();
      console.log('[BOOT] authed as', session?.user?.email);
    } catch (e) {
      console.error('[BOOT] requireAuth failed', e);
      statusEl.textContent = 'Auth required';
      throw e;
    }
  
    // Router
    const router = initRouter({
      onChange: ({ tableKey, page = 1, q = "" }) => {
        console.log('[ROUTER] onChange', { tableKey, page, q });
        const keys = Object.keys(TABLES || {});
        if (!keys.length) {
          statusEl.textContent = 'No tables defined';
          return;
        }
        const def = TABLES[tableKey] ?? TABLES[keys[0]];
        document.getElementById('page-title').textContent = def.title;
        renderTableView({
          def,
          container: document.getElementById('table-region'),
          filtersEl: document.getElementById('filters'),
          pagerEl: document.getElementById('pager'),
          statusEl,
          addBtn: document.getElementById('add-btn'),
          searchInput: document.getElementById('search-input'),
          page,
          search: q
        });
      }
    });
  
    console.log('[BOOT] router ready; building sidebar');
    buildSidebar(sidebarEl, TABLES, router);
    console.log('[BOOT] done');
  </script>
</body>
</html>