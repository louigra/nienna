<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nienna — Sign in</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link href="./styles.css" rel="stylesheet" />
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <div class="container py-5">
    <header class="mb-4">
      <h1 class="h3 mb-1">Welcome to the Nienna Alpha</h1>
      <p class="text-secondary mb-0" id="status">Please sign in.</p>
    </header>

    <div id="auth-area" class="row g-3">
      <!-- Sign up -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h5 mb-3">Sign up</h2>
            <div class="row g-2 align-items-center">
              <div class="col-12 col-md"><input id="su-email" class="form-control" placeholder="Email" /></div>
              <div class="col-12 col-md"><input id="su-pass" type="password" class="form-control" placeholder="Password" /></div>
              <div class="col-12 col-md-auto"><button id="su-btn" class="btn btn-primary w-100">Create account</button></div>
            </div>
            <p class="text-secondary small mb-0 mt-2" id="su-msg"></p>
          </div>
        </div>
      </div>
      <!-- Sign in -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h5 mb-3">Sign in</h2>
            <div class="row g-2 align-items-center">
              <div class="col-12 col-md"><input id="si-email" class="form-control" placeholder="Email" /></div>
              <div class="col-12 col-md"><input id="si-pass" type="password" class="form-control" placeholder="Password" /></div>
              <div class="col-12 col-md-auto"><button id="si-btn" class="btn btn-success w-100">Sign in</button></div>
            </div>
            <div class="row g-2 align-items-center mt-2">
              <div class="col-12 col-md"><input id="ml-email" class="form-control" placeholder="Email for magic link" /></div>
              <div class="col-12 col-md-auto"><button id="ml-btn" class="btn btn-outline-secondary w-100">Send magic link</button></div>
            </div>
            <p class="text-secondary small mb-0 mt-2" id="si-msg"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reusable modal -->
  <div class="modal fade" id="appModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title" id="appModalTitle">Notice</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="appModalBody"></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">OK</button></div>
      </div>
    </div>
  </div>

  
  <script type="module">
    import { supabase } from "./auth-guard.js";

    const $ = (s) => document.querySelector(s);
    const status = $('#status');

    // modal helper
    function showModal(title, msg) {
      $('#appModalTitle').textContent = title;
      $('#appModalBody').textContent = msg;
      new bootstrap.Modal('#appModal').show();
    }

    // if already signed in, go straight to dashboard
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) window.location.href = "dashboard.html";
    })();

    // sign in
    $('#si-btn').onclick = async () => {
      const email = $('#si-email').value.trim();
      const password = $('#si-pass').value;
      $('#si-msg').textContent = 'Signing in…';
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { $('#si-msg').textContent = ''; showModal('Sign-in Error', error.message); return; }
      window.location.href = "dashboard.html";
    };

    // sign up (restrict to @mtacd.org)
    $('#su-btn').onclick = async () => {
      const emailInput = $('#su-email');
      const passInput  = $('#su-pass');
      const email = emailInput.value.trim();
      if (!email.endsWith('@mtacd.org')) {
        showModal('Sign-up Restricted', 'Sign-ups are limited to @mtacd.org addresses.');
        emailInput.value = ''; passInput.value = ''; emailInput.focus(); return;
      }
      const btn = $('#su-btn'); btn.disabled = true;
      try {
        $('#su-msg').textContent = 'Signing up…';
        const { data, error } = await supabase.auth.signUp({
          email, password: passInput.value,
          options: { emailRedirectTo: window.location.origin + window.location.pathname.replace('index.html','dashboard.html') }
        });
        if (error) return showModal('Sign-up Error', error.message || 'Unable to create account.');
        showModal('Check your email', 'We sent a confirmation link to finish creating your account.');
        emailInput.value=''; passInput.value=''; $('#su-msg').textContent='';
      } finally { btn.disabled = false; }
    };

    // magic link
    $('#ml-btn').onclick = async () => {
      const email = $('#ml-email').value.trim();
      $('#si-msg').textContent = 'Sending magic link…';
      const { error } = await supabase.auth.signInWithOtp({
        email, options: { emailRedirectTo: window.location.origin + '/dashboard.html' }
      });
      if (error) return showModal('Magic Link Error', error.message);
      $('#si-msg').textContent = 'Magic link sent. Check your inbox.';
    };
  </script>
</body>
</html>