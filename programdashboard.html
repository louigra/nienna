<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nienna — Programming</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="./styles.css" rel="stylesheet" />
  <style>
    :root {
      --brand: #0039A6;
      --glass-bg: rgba(18, 20, 25, 0.6);
      --glass-border: rgba(255,255,255,.08);
    }
    body { 
      background: radial-gradient(1200px 600px at 10% -10%, rgba(0, 57, 166, .22), transparent),
                  radial-gradient(1200px 600px at 90% 110%, rgba(0, 0, 0, .18), transparent),
                  linear-gradient(160deg, #0b0c10 0%, #0f1116 100%);
      min-height: 100vh;
    }
    .page-header {
      background: linear-gradient(90deg, rgba(0, 57, 166, .2), rgba(233, 87, 77, 0));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .toolbar-card, .filters-card, .table-wrap-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .btn-brand { background: var(--brand); border-color: var(--brand); }
    .btn-brand:hover { filter: brightness(1.08); }
    .select-inline { min-width: 120px; }
    .section-title { letter-spacing: .02em; }
    .table-wrap-card{ border-radius: 1rem; }
    .muted { color: #98a2b3; }

    .budget-panel {
      background: rgba(15,15,18,.35);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    
    .progress {
      background: rgba(255,255,255,.06) !important;
    }
    .progress-bar.bg-success {
      background-color: #28a745 !important;
    }
    .progress-bar.bg-danger {
      background-color: #dc3545 !important;
    }
  </style>
</head>
<body>

  <div class="page-header">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          <i class="bi bi-bar-chart-line fs-4 text-danger-emphasis"></i>
          <div>
            <h1 class="h4 mb-0">Programming Dashboard</h1>
            <div class="muted small">Live overview of the program being planned</div>
          </div>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-light" href="landingpage.html"><i class="bi bi-grid-3x3-gap text-warning me-1"></i> Back to Tiles</a>
        </div>
      </div>
    </div>
  </div>

  <div class="container py-4">
    <!-- Controls Row -->
    <div class="row g-3 align-items-stretch mb-3">
      <!-- Tier card -->
      <div class="col-12 col-lg-4">
        <div class="toolbar-card h-100 p-3">
          <h2 class="h6 mb-3 section-title">Tier</h2>
          <form class="row g-2 align-items-center">
            <div class="col-auto"><label for="tier-select" class="col-form-label">Tier</label></div>
            <div class="col-auto">
              <select id="tier-select" name="selected-tier" class="form-select select-inline">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
            </div>
          </form>
        </div>
      </div>

      <!-- Filters card -->
      <div class="col-12 col-lg-8">
        <div class="filters-card h-100 p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="h6 mb-0 section-title">Filter</h2>
            <div class="muted small">Use any combination</div>
          </div>
          <form class="row g-2">
            <div class="col-12 col-sm-3">
              <label for="agency-select" class="form-label">Agency</label>
              <select id="agency-select" name="selected-agency" class="form-select">
              </select>
            </div>
            <div class="col-12 col-sm-3">
              <label for="cip-select" class="form-label">CIP</label>
              <select id="cip-select" name="selected-cip" class="form-select">
              </select>
            </div>
            <div class="col-12 col-sm-3">
              <label for="category-select" class="form-label">Category</label>
              <select id="category-select" name="selected-category" class="form-select">
              </select>
            </div>
            <div class="col-12 col-sm-3">
              <label for="element-select" class="form-label">Element</label>
              <select id="element-select" name="selected-element" class="form-select">
              </select>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Chart area -->
    <div class="table-wrap-card h-100 p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 mb-0 section-title">Charts</h2>
        <div class="muted small">Click on any chart to see the data</div>
      </div>
      <canvas id="chart-canvas" style="width:100%;max-height:600px"></canvas>
    </div>

    <p class="text-secondary small mt-2" id="app-msg"></p>
  </div>


  <!-- Bootstrap JS bundle (for Modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0"></script> 

  <script type="module">
    import { supabase, requireAuth } from "./auth-guard.js";
  
    const appMsg = document.getElementById('app-msg');
  
    // Only create a Modal if it exists on this page
    const modalEl = document.getElementById('projectModal');
    const modal   = modalEl ? new bootstrap.Modal(modalEl) : null;
  
    // Helpers
    const asNum = (v) => Number.isFinite(Number(v)) ? Number(v) : null;
  
    // Render pie using the correct canvas id
    let pie;
    function renderPie(labels, values, colors) {
      const ctx = document.getElementById('chart-canvas');
      if (!ctx) { console.error('#chart-canvas not found'); return; }
      if (pie) pie.destroy();
      pie = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
        options: {
          plugins: {
            title: { display: true, text: '5-Year Total by ACEP', padding: {top: 0, bottom: 0}},
            legend: { position: 'right' },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.label}: ${Number(ctx.parsed).toLocaleString()}`
              }
            }
          }
        }
      });
    }
  
    // Build filter selects
    async function getDistinct(table, column) {
      const { data, error } = await supabase
        .from(table)
        .select(column, { distinct: true })
        .not(column, 'is', null)
        .order(column, { ascending: true });
      if (error) throw error;
      return (data || []).map(r => r[column]).filter(v => v != null);
    }
    function fillSelect(selectEl, values, { display = v => String(v), value = v => String(v) } = {}) {
      selectEl.innerHTML = '<option value="">All</option>';
      [...new Set(values)].forEach(v => {
        const opt = document.createElement('option');
        opt.value = value(v);
        opt.textContent = display(v);
        selectEl.appendChild(opt);
      });
    }
    async function buildFiltersFromACEPs() {
      appMsg.textContent = 'Loading filters…';
      const agencySelect   = document.getElementById('agency-select');
      const cipSelect      = document.getElementById('cip-select');
      const categorySelect = document.getElementById('category-select');
      const elementSelect  = document.getElementById('element-select');
  
      const [agencies, cips, cats, elems] = await Promise.all([
        getDistinct('aceps','agency'),
        getDistinct('aceps','cip'),
        getDistinct('aceps','category'),
        getDistinct('aceps','element')
      ]);
  
      fillSelect(agencySelect, agencies);
      fillSelect(cipSelect, cips);
      fillSelect(categorySelect, cats);
      fillSelect(elementSelect, elems, { display: v => String(v).padStart(2,'0') });
  
      appMsg.textContent = '';
    }
  
    // Boot
    try {
      await requireAuth();
  
      // 1) ACEP totals
      const { data: rows, error: rowsErr } = await supabase
      .from('acep_project_totals')
      .select('agency, cip, category, element, total_5yr_sum')
      .order('agency', { ascending: true })
      .order('cip', { ascending: true })
      .order('category', { ascending: true })
      .order('element', { ascending: true })
      .eq('cip', 9);

      if (rowsErr) throw rowsErr;

      const labels = (rows || []).map(r => {
      const cat = String(r.category).padStart(2, '0');
      const el = String(r.element).padStart(2, '0');
      return `${r.agency}${r.cip}${cat}${el}`;
      });
      const values = (rows || []).map(r => Number(r.total_5yr_sum) || 0);
      const colors = labels.map((_, i) => `hsl(${(i * 47) % 360} 65% 55%)`);

      // get sum of values
      const sumValues = values.reduce((a, b) => a + b, 0);

      const { data: envelopeSum, error: envelopeErr } =
      await supabase.rpc('app_sum_envelope', { p_tier: 1, p_cip: 9 });

      if (envelopeErr) throw envelopeErr;

      labels.push('Unprogrammed Envelope');
      values.push(Number(envelopeSum - sumValues) || 0);

      console.log({'sumValues': sumValues, 'envelopeSum': envelopeSum})

      renderPie(labels, values, colors);

      // Build filter dropdowns
      await buildFiltersFromACEPs();
  
    } catch (err) {
      console.error(err);
      appMsg.textContent = err?.message || 'Initialization failed.';
    }
  </script>
</body>
</html>
